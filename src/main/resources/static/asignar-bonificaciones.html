<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Asignar Bonificaciones</title>
    <link rel="stylesheet" href="Estilos.css">
    <script src="vistaWeb.js"></script>
    <script src="sse.js"></script>
    <script defer src="utilesVista.js"></script>

    <script>
        window.urlRegistroSSE = "/asignarBonificaciones/registrarSSE";

        document.addEventListener('DOMContentLoaded', function () {
            fetch('/asignarBonificaciones')
                .then(res => res.json())
                .then(bonificaciones => mostrar_bonificaciones(bonificaciones));

            fetch('/asignarBonificaciones/puestos')
                .then(res => res.json())
                .then(puestos => mostrar_puestos(puestos));
        });

        function mostrar_bonificaciones(bonificaciones) {
            document.getElementById("divBonificaciones").innerHTML = crearListaDesdeJson({
                data: bonificaciones,
                campoMostrar: "nombre",
                id: "bonificacionSelect"
            });
        }

        function mostrar_puestos(puestos) {
            document.getElementById("divPuestos").innerHTML = crearListaDesdeJson({
                data: puestos,
                campoMostrar: "nombre",
                id: "puestoSelect"
            });
        }

        function buscarPropietario(event) {
            event.preventDefault();
            submit("/asignarBonificaciones/buscarPropietario",
                serializarFormulario("formBuscarPropietario"));
        }

        function procesarRespuestaSubmit(text) {
            let respuesta = typeof text === "string" ? JSON.parse(text) : text;

            if (respuesta.id === "resultadoBusqueda") {
                const dto = respuesta.parametro;
                mostrarPanelPropietario(dto);
            }
        }

        function seleccionarPropietario(dto) {
            let bonificacionesHtml = '';

            if (dto.bonificacionesAsignadas?.length > 0) {
                bonificacionesHtml = `<table><thead><tr><th>Bonificación</th><th>Puesto</th></tr></thead><tbody>`;
                dto.bonificacionesAsignadas.forEach(b => {
                    bonificacionesHtml += `<tr><td>${b.bonificacion || b.nombreBonificacion}</td><td>${b.puesto || b.nombrePuesto}</td></tr>`;
                });
                bonificacionesHtml += `</tbody></table>`;
            } else {
                bonificacionesHtml = '<p>Sin bonificaciones asignadas</p>';
            }

            document.getElementById("panelPropietario").innerHTML = `
                <div class="card">
                    <h3>Propietario</h3>
                    <p><strong>Nombre:</strong> ${dto.nombreCompleto}</p>
                    <p><strong>Estado:</strong> ${dto.estado}</p>
                    <h4>Bonificaciones asignadas</h4>
                    ${bonificacionesHtml}
                </div>
            `;
        }
    </script>
    <script>
        let propietarioActual = null;
        let cedulaBuscada = null;

        function actualizarEstadoBotonAsignar() {
            const bonificacion = document.getElementById('bonificacionSelect')?.value;
            const puesto = document.getElementById('puestoSelect')?.value;
            const habilitado = propietarioActual && bonificacion && puesto && bonificacion !== "-1" && puesto !== "-1";
            document.getElementById('btnAsignarBonificacion').disabled = !habilitado;
        }

        document.addEventListener('change', function (e) {
            if (["bonificacionSelect", "puestoSelect"].includes(e.target.id)) {
                actualizarEstadoBotonAsignar();
            }
        });

        document.getElementById('btnAsignarBonificacion').addEventListener('click', function () {
            const bonificacion = document.getElementById('bonificacionSelect').value;
            const puesto = document.getElementById('puestoSelect').value;
            if (!propietarioActual || !bonificacion || !puesto || bonificacion === "-1" || puesto === "-1") return;

            if (!cedulaBuscada) {
                alert("Primero debe buscar un propietario");
                return;
            }

            // Enviar los valores seleccionados (string, no índice)
            submit(
                '/asignarBonificaciones/asignar',
                `cedula=${encodeURIComponent(cedulaBuscada)}&bonificacion=${encodeURIComponent(bonificacion)}&puesto=${encodeURIComponent(puesto)}`
            );
        });

        function mostrarPanelPropietario(dto) {
            propietarioActual = dto;
            actualizarEstadoBotonAsignar();
            let bonificacionesHtml = '';
            if (dto && dto.bonificacionesAsignadas?.length > 0) {
                bonificacionesHtml = `<table><thead><tr><th>Bonificación</th><th>Puesto</th></tr></thead><tbody>`;
                dto.bonificacionesAsignadas.forEach(b => {
                    bonificacionesHtml += `<tr><td>${b.bonificacion || b.nombreBonificacion}</td><td>${b.puesto || b.nombrePuesto}</td></tr>`;
                });
                bonificacionesHtml += `</tbody></table>`;
            } else {
                bonificacionesHtml = '<p>Sin bonificaciones asignadas</p>';
            }
            document.getElementById("panelPropietario").innerHTML = dto ? `
                <div class="card">
                    <h3>Propietario</h3>
                    <p><strong>Nombre:</strong> ${dto.nombreCompleto}</p>
                    <p><strong>Estado:</strong> ${dto.estado}</p>
                    <h4>Bonificaciones asignadas</h4>
                    ${bonificacionesHtml}
                </div>
            ` : '<p>No existe el propietario</p>';
        }
    </script>
</head>

<body>

    <!-- ESTE DIV ES OBLIGATORIO PARA QUE LAS COLUMNAS SE ARMEN -->
    <div class="main-center">
        <div class="card-asignar">

            <h1>Asignar bonificaciones</h1>

            <!-- AHORA SÍ: ESTO GENERA 2 COLUMNAS -->
            <div class="row">

                <!-- COLUMNA IZQUIERDA -->
                <div class="col-izq">

                    <div class="form-group">
                        <label for="bonificacionSelect">Bonificaciones definidas</label>
                        <div id="divBonificaciones"></div>
                    </div>

                    <div class="form-group">
                        <label for="puestoSelect">Puestos definidos</label>
                        <div id="divPuestos"></div>
                    </div>

                    <div class="form-group">
                        <button id="btnAsignarBonificacion" type="button" disabled>Asignar bonificación</button>
                    </div>

                </div>

                <!-- COLUMNA DERECHA -->
                <div class="col-der">

                    <h2>Búsqueda de propietario</h2>

                    <form id="formBuscarPropietario" onsubmit="buscarPropietario(event)">
                        <div class="form-group">
                            <label for="cedulaPropietario">Cédula de identidad</label>
                            <input type="text" id="cedulaPropietario" name="cedula" required>
                        </div>

                        <button type="submit">Buscar propietario</button>
                    </form>

                    <div id="panelPropietario"></div>
                </div>

            </div>

        </div>
    </div>

</body>
</html>
