<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Asignar Bonificaciones</title>
    <link rel="stylesheet" href="Estilos.css">
    <script src="vistaWeb.js"></script>
    <script src="sse.js"></script>
    <script defer src="utilesVista.js"></script>
</head>
<body>
    <div class="login-container" style="max-width: 900px; text-align: left;">
        <h2 style="margin-bottom: 10px;">Asignar bonificaciones</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start;">
            <!-- Columna izquierda -->
            <div>
                <div class="input-group">
                    <label for="bonificacionSelect">Bonificaciones definidas</label>
                    <div id="divBonificaciones"></div>
                </div>
                <div class="input-group">
                    <label for="puestoSelect">Puestos definidos</label>
                    <div id="divPuestos"></div>
                </div>
                <div class="input-group">
                    <button id="btnAsignarBonificacion" type="button" disabled style="width: 100%;">Asignar bonificación</button>
                </div>
            </div>
            <!-- Columna derecha -->
            <div>
                <label style="font-weight: bold; margin-bottom: 8px; display: block;">Cédula de identidad</label>
                <form id="formBuscarPropietario" onsubmit="buscarPropietario(event)" style="margin-bottom: 18px;">
                    <div class="input-group" style="margin-bottom: 0;">
                        <input type="text" id="cedulaPropietario" name="cedula" required style="margin-bottom: 0;" />
                    </div>
                    <button type="submit" style="width: 100%;">Buscar propietario</button>
                </form>
                <div id="panelPropietario"></div>
            </div>
        </div>
        <footer style="margin-top: 18px; color: #888; font-size: 13px; text-align:center;">© 2025 – Administración</footer>
    </div>

    <script>

        urlIniciarVista = "/asignarBonificaciones/vistaConectada";
        urlCierreVista  = "/asignarBonificaciones/vistaCerrada";
        urlRegistroSSE  = "/asignarBonificaciones/registrarSSE";

        let propietarioActual = null;
        let cedulaBuscada = null;


        function actualizarEstadoBotonAsignar() {
            const bonificacion = document.getElementById('bonificacionSelect')?.value;
            const puesto = document.getElementById('puestoSelect')?.value;
            const habilitado =
                propietarioActual &&
                bonificacion && puesto &&
                bonificacion !== "-1" &&
                puesto !== "-1";

            const btn = document.getElementById('btnAsignarBonificacion');
            if (btn) btn.disabled = !habilitado;
        }

        function mostrarPanelPropietario(dto) {
            propietarioActual = dto;
            actualizarEstadoBotonAsignar();

            let bonificacionesHtml = '';
            if (dto && dto.bonificacionesAsignadas?.length > 0) {
                bonificacionesHtml = `<table><thead><tr><th>Bonificación</th><th>Puesto</th></tr></thead><tbody>`;
                dto.bonificacionesAsignadas.forEach(b => {
                    bonificacionesHtml += `<tr>
                        <td>${b.bonificacion || b.nombreBonificacion}</td>
                        <td>${b.puesto || b.nombrePuesto}</td>
                    </tr>`;
                });
                bonificacionesHtml += `</tbody></table>`;
            } else {
                bonificacionesHtml = '<p>Sin bonificaciones asignadas</p>';
            }

            document.getElementById("panelPropietario").innerHTML = dto ? `
                <div class="card">
                    <h3>Propietario</h3>
                    <p><strong>Nombre:</strong> ${dto.nombreCompleto}</p>
                    <p><strong>Estado:</strong> ${dto.estado}</p>
                    <h4>Bonificaciones asignadas</h4>
                    ${bonificacionesHtml}
                </div>
            ` : '<p>No existe el propietario</p>';
        }

        function mostrar_bonificaciones(bonificaciones) {
            document.getElementById("divBonificaciones").innerHTML = crearListaDesdeJson({
                data: bonificaciones,
                campoMostrar: "nombre",
                campoValor: "nombre",
                id: "bonificacionSelect"
            });
            actualizarEstadoBotonAsignar();
        }

        function mostrar_puestos(puestos) {
            document.getElementById("divPuestos").innerHTML = crearListaDesdeJson({
                data: puestos,
                campoMostrar: "nombre",
                campoValor: "nombre",
                id: "puestoSelect"
            });
            actualizarEstadoBotonAsignar();
        }

        function mostrar_resultadoBusqueda(dto) {
            mostrarPanelPropietario(dto);
        }



        function buscarPropietario(event) {
            event.preventDefault();
            const inputCedula = document.getElementById('cedulaPropietario');
            cedulaBuscada = inputCedula ? inputCedula.value : null;

            submit(
                "/asignarBonificaciones/buscarPropietario",
                serializarFormulario("formBuscarPropietario")
            );
        }

        document.addEventListener('change', function (e) {
            if (["bonificacionSelect", "puestoSelect"].includes(e.target.id)) {
                actualizarEstadoBotonAsignar();
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            const btn = document.getElementById('btnAsignarBonificacion');
            if (!btn) return;

            btn.addEventListener('click', function () {
                const bonificacion = document.getElementById('bonificacionSelect')?.value;
                const puesto = document.getElementById('puestoSelect')?.value;

                if (!propietarioActual || !bonificacion || !puesto ||
                    bonificacion === "-1" || puesto === "-1") {
                    return;
                }

                if (!cedulaBuscada) {
                    mostrarMensaje("Primero debe buscar un propietario");
                    return;
                }

                submit(
                    "/asignarBonificaciones/asignar",
                    `cedula=${encodeURIComponent(cedulaBuscada)}&bonificacion=${encodeURIComponent(bonificacion)}&puesto=${encodeURIComponent(puesto)}`
                );
            });
        });


        function procesarErrorSubmit(status, text) {
            if (status === 400) {
                window.location.href = "login-admin.html";
            }
        }
    </script>
</body>
</html>
