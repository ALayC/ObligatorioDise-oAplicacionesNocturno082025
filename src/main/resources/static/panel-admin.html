<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <link rel="stylesheet" href="Estilos.css">
    <script src="vistaWeb.js"></script>
    <script src="sse.js"></script>
</head>
<body>
    <script src="utilesVista.js"></script>

    <!-- Barra lateral -->
    <div class="sidebar">
        <h2 style="margin-bottom: 20px;">Panel de Administración</h2>

        <button onclick="cargarContenido('monitor-actividad.html')">
            Monitor de actividad
        </button>

        <button onclick="cargarContenido('asignar-bonificaciones.html')">
            Asignar bonificaciones
        </button>

        <button onclick="cargarContenido('cambiar-estado-propietario.html')">
            Cambiar estado de propietario
        </button>

        <button onclick="logout()" style="margin-top:auto; background-color:#b22222;">
            Cerrar sesión
        </button>
    </div>

    <!-- Área de contenido -->
    <div class="content">
        <iframe id="contenidoFrame"
                src="monitor-actividad.html"
                frameborder="0"
                style="width:100%; height:100vh;"></iframe>
    </div>

    <script>
        // --- Configuración para vistaWeb / SSE ---
        // POST inicial cuando la vista está lista (registra observador, etc.)
        window.urlIniciarVista = "/admin/vistaConectada";
        // Se llama cuando se cierra la página (podés notificar que la vista se cerró)
        window.urlCierreVista  = "/admin/vistaCerrada";
        // URL para registrar SSE
        window.urlRegistroSSE  = "/admin/registrarSSE";

        // Carga una de las vistas de admin dentro del iframe
        function cargarContenido(pagina) {
            document.getElementById('contenidoFrame').src = pagina;
        }

        // Logout de administrador
        function logout() {
            submit("/acceso/logoutAdmin", "");
        }

        // Si el submit devuelve error de sesión, volver al login de admin
        function procesarErrorSubmit(status, text) {
            if (status === 400 || status === 401) {
                window.location.href = "login-admin.html";
            }
        }

        // El backend, cuando hace logout, te devuelve algo como { paginaLogin : "login-admin.html" }
        function mostrar_paginaLogin(url) {
            window.location.href = url;
        }

        // Cuando llega un mensaje SSE desde el servidor, lo reenviamos al iframe
        // para que lo procese como si fuera una respuesta AJAX normal.
        function procesarMensajeSSE(mensaje) {
            var iframe = document.getElementById('contenidoFrame');
            if (!iframe || !iframe.contentWindow) return;
            if (typeof iframe.contentWindow.procesarResultadosSubmit === "function") {
                iframe.contentWindow.procesarResultadosSubmit(mensaje);
            }
        }

        // Cuando el servidor cierra la conexión SSE
        function conexionSSECerrada(event) {
            // Si no querés hacer nada especial, podés dejarlo vacío
            console.log("Conexión SSE cerrada", event);
        }
    </script>
</body>
</html>
