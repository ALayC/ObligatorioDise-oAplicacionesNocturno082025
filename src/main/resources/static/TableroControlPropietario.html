<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tablero de control del propietario</title>

  <link rel="stylesheet" href="Estilos.css">

  <!-- 1) vistaWeb primero (define submit(), etc.) -->
  <script src="vistaWeb.js"></script>
  <script src="sse.js"></script>
  <!-- 2) Config para iniciar la vista llamando al backend -->
  <script>
    window.urlIniciarVista = "/propietario/vistaConectada";
    window.parametrosInicioVista = "";
    window.urlCierreVista = "/propietario/vistaCerrada";
    window.parametrosCierreVista = "";

    // Configuración SSE para actualizaciones automáticas
    window.urlRegistroSSE = "/propietario/registrarSSE";

    // si no hay sesión, redirige a login
    window.procesarErrorSubmit = function (status, text) {
      if (status === 400) {
        window.location.href = "login.html";
        return;
      }
      console.error("Error en submit:", status, text);
      alert("Se produjo un error");
    };

    // Mostrar indicador de actualización automática cuando SSE esté activo
    window.conexionSSECerrada = function () {
      document.getElementById('autoRefreshStatus').style.display = 'none';
    };
    window.procesarMensajeSSE = function (mensaje) {
      document.getElementById('autoRefreshStatus').style.display = '';
      procesarResultadosSubmit(mensaje);
    };
  </script>

  <!-- 3) utilidades. Dejalo después para asegurar la versión correcta de serializarFormulario -->
  <script defer src="utilesVista.js"></script>

  <style>
    /* Layout general del tablero */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f0f2f5;
      color: #333;
    }

    .wrap {
      max-width: 1100px;
      margin: 24px auto;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .card {
      background: #ffffff;
      border-radius: 14px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
      padding: 14px;
    }

    .card h3 {
      margin: 0 0 8px 0;
      font-size: 1rem;
      color: #212121;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .pill {
      background: #e3f2fd;
      /* celeste suave */
      border: 1px solid #bbdefb;
      border-radius: 10px;
      padding: 10px 12px;
    }

    /* Label arriba: chiquita, gris, mayúsculas */
    .v-label {
      display: block;
      font-size: 0.7rem;
      color: #607d8b;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 2px;
    }

    /* Valor abajo: más grande y fuerte */
    .v {
      display: block;
      font-size: 0.95rem;
      font-weight: 600;
      color: #212121;
    }

    /* Tablas */
    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead th {
      text-align: left;
      background: #1976d2;
      /* azul principal */
      color: #ffffff;
      font-weight: 600;
      border-bottom: 1px solid #1565c0;
      padding: 8px;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    tbody td {
      border-bottom: 1px solid #e0e0e0;
      padding: 8px;
      font-size: 0.9rem;
    }

    tbody tr:nth-child(even) {
      background-color: #fafafa;
    }

    /* Toolbar inferior (botón borrar) */
    .toolbar {
      display: flex;
      justify-content: flex-end;
      margin-top: 12px;
    }

    .btn {
      background: #e91e63;
      /* fucsia material para acción “fuerte” */
      color: #ffffff;
      border: 0;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.16);
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
    }

    .btn:hover {
      background: #d81b60;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    /* Top bar con título + enlace salir */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    .topbar h1 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
      color: #212121;
    }

    .topbar a {
      color: #757575;
      text-decoration: none;
      font-size: 0.9rem;
    }

    .topbar a:hover {
      text-decoration: underline;
    }

    .auto-refresh-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: #2e7d32;
      background: #e8f5e9;
      padding: 4px 10px;
      border-radius: 12px;
      border: 1px solid #c8e6c9;
    }

    .auto-refresh-indicator::before {
      content: "⟳";
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Responsive */
    @media (max-width: 900px) {
      .row {
        grid-template-columns: 1fr;
      }

      .grid-3 {
        grid-template-columns: 1fr;
      }
    }
  </style>

</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h2>Tablero de control del propietario</h2>
      <div style="display: flex; gap: 12px; align-items: center;">
        <span id="autoRefreshStatus" class="auto-refresh-indicator" style="display: none;">
          Actualización automática
        </span>
        <a href="#" onclick="logout()">Salir</a>
      </div>
    </div>

    <!-- Resumen -->
    <div class="card">
      <h3>Resumen del propietario</h3>
      <div class="grid-3">
        <div class="pill">
          <span class="v-label">Nombre completo</span>
          <span class="v" id="cabeceraNombre">Walter</span>
        </div>
        <div class="pill">
          <span class="v-label">Estado</span>
          <span class="v" id="cabeceraEstado">Habilitado</span>
        </div>
        <div class="pill">
          <span class="v-label">Saldo actual</span>
          <span class="v" id="cabeceraSaldo">$ 2.000,00</span>
        </div>
      </div>
    </div>

    <div class="row">
      <!-- Bonificaciones -->
      <div class="card">
        <h3>Bonificaciones asignadas</h3>
        <table>
          <thead>
            <tr>
              <th>Bonificación</th>
              <th>Puesto</th>
              <th>Fecha asignada</th>
            </tr>
          </thead>
          <tbody id="tbodyBonificaciones">
            <tr>
              <td colspan="3">Sin bonificaciones</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Vehículos -->
      <div class="card">
        <h3>Vehículos registrados</h3>
        <table>
          <thead>
            <tr>
              <th>Matrícula</th>
              <th>Modelo</th>
              <th>Color</th>
              <th>Tránsitos</th>
              <th>Monto total</th>
            </tr>
          </thead>
          <tbody id="tbodyVehiculos">
            <tr>
              <td colspan="5">Sin vehículos</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Tránsitos -->
    <div class="card">
      <h3>Tránsitos realizados</h3>
      <table>
        <thead>
          <tr>
            <th>Puesto</th>
            <th>Matrícula</th>
            <th>Tarifa</th>
            <th>Monto tarifa</th>
            <th>Bonificación</th>
            <th>Monto bonificación</th>
            <th>Monto pagado</th>
            <th>Fecha</th>
            <th>Hora</th>
          </tr>
        </thead>
        <tbody id="tbodyTransitos">
          <tr>
            <td colspan="9">Sin tránsitos</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Notificaciones -->
    <div class="card">
      <div class="topbar" style="margin-bottom:0">
        <h3>Notificaciones del sistema</h3>
        <div class="toolbar">
          <button id="btnBorrarNotifs" class="btn" onclick="borrarNotificaciones()">Borrar notificaciones</button>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th>Fecha y hora</th>
            <th>Mensaje</th>
          </tr>
        </thead>
        <tbody id="tbodyNotificaciones">
          <tr>
            <td colspan="2">Sin notificaciones</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // ===== Helpers para mostrar datos devueltos por el backend =====
    function fmtMoneda(v) { try { return new Intl.NumberFormat('es-UY', { style: 'currency', currency: 'UYU' }).format(v); } catch (_) { return "$ " + v; } }
    const setText = (id, val) => document.getElementById(id).textContent = val ?? "—";

    function mostrar_cabecera(dto) {
      console.log("mostrar_cabecera llamada con:", dto);
      setText('cabeceraNombre', dto.propietarioNombreCompleto);
      setText('cabeceraEstado', dto.estado);
      setText('cabeceraSaldo', fmtMoneda(dto.saldoActual));
    }

    function mostrar_bonificaciones(lista) {
      console.log("mostrar_bonificaciones llamada con:", lista);
      if (!Array.isArray(lista)) {
        console.warn("El parámetro recibido no es un array:", lista);
      } else {
        lista.forEach((b, i) => {
          console.log(`Bonificación[${i}]:`, b);
        });
      }
      const tbody = document.getElementById('tbodyBonificaciones'); tbody.innerHTML = "";
      if (!lista || !lista.length) { tbody.innerHTML = `<tr><td colspan="3">Sin bonificaciones</td></tr>`; return; }
      for (const b of lista) {
        // Formatear fechaAsignada (LocalDateTime ISO) a dd/MM/yyyy HH:mm
        let fecha = "—";
        if (b.fechaAsignada) {
          const partes = b.fechaAsignada.split("T");
          if (partes.length === 2) {
            const [y, m, d] = partes[0].split("-");
            const hora = partes[1].substring(0, 5);
            fecha = `${d}/${m}/${y} ${hora}`;
          } else {
            fecha = b.fechaAsignada;
          }
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${b.bonificacion}</td><td>${b.puesto}</td><td>${fecha}</td>`;
        tbody.appendChild(tr);
      }
    }

    function mostrar_vehiculos(lista) {
      console.log("mostrar_vehiculos llamada con:", lista);
      const tbody = document.getElementById('tbodyVehiculos'); tbody.innerHTML = "";
      if (!lista || !lista.length) { tbody.innerHTML = `<tr><td colspan="5">Sin vehículos</td></tr>`; return; }
      for (const v of lista) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${v.matricula}</td><td>${v.modelo}</td><td>${v.color}</td><td>${v.cantidadTransitos ?? 0}</td><td>${fmtMoneda(v.montoTotalGastado ?? 0)}</td>`;
        tbody.appendChild(tr);
      }
    }

    function mostrar_transitos(lista) {
      const tbody = document.getElementById('tbodyTransitos'); tbody.innerHTML = "";
      if (!lista || !lista.length) { tbody.innerHTML = `<tr><td colspan="9">Sin tránsitos</td></tr>`; return; }
      for (const t of lista) {
        // Mostrar fecha y hora directamente
        const fecha = t.fecha ?? "—";
        const hora = t.hora ?? "—";
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.puesto}</td><td>${t.matricula}</td><td>${t.nombreTarifa}</td>
          <td>${fmtMoneda(t.montoTarifa)}</td><td>${t.bonificacion ?? "—"}</td>
          <td>${fmtMoneda(t.montoBonificacion ?? 0)}</td><td>${fmtMoneda(t.montoPagado)}</td>
          <td>${fecha}</td><td>${hora}</td>`;
        tbody.appendChild(tr);
      }
    }

    function mostrar_notificaciones(lista) {
      const tbody = document.getElementById('tbodyNotificaciones'); tbody.innerHTML = "";
      if (!lista || !lista.length) { tbody.innerHTML = `<tr><td colspan="2">Sin notificaciones</td></tr>`; return; }
      for (const n of lista) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${n.fechaHora ?? "—"}</td><td>${n.mensaje}</td>`;
        tbody.appendChild(tr);
      }
    }

    // feedback de borrado
    function mostrar_notificacionesBorradas(cantidad) {
      document.getElementById('tbodyNotificaciones').innerHTML = `<tr><td colspan="2">Sin notificaciones</td></tr>`;
      alert(`Se borraron ${cantidad} notificación(es).`);
    }

    // acciones
    function borrarNotificaciones() { submit("/propietario/notificaciones/borrar", ""); }

    // logout real (endpoint correcto)
    function logout() {
      submit("/acceso/logoutPropietario", "");
      window.location.href = "login.html";
    }

    // errores de negocio
    async function excepcionDeAplicacion(text) { alert(text); }



  </script>
</body>

</html>
</script>
</body>

</html>