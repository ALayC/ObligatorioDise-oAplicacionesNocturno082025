<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cambiar estado de propietario</title>
    <link rel="stylesheet" href="Estilos.css">
    <script src="vistaWeb.js"></script>
    <script src="sse.js"></script>
</head>
<body>
    <script src="utilesVista.js"></script>

    <div class="login-container" style="max-width: 900px; text-align: left;">
        <h2 style="margin-bottom: 10px;">Cambiar estado de propietario</h2>
        <p style="color: #555; margin-bottom: 18px;">
            Ingrese la cédula, revise el estado actual y seleccione un nuevo estado.
        </p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start;">
            <!-- Columna izquierda: cédula y búsqueda -->
            <div>
                <label style="font-weight: bold; margin-bottom: 8px; display: block;">Cédula de identidad</label>
                <form id="formBuscar" style="margin-bottom: 18px;" onsubmit="buscarPropietario(event)">
                    <div class="input-group" style="margin-bottom: 0;">
                        <input type="text" id="cedula" name="cedula" required />
                    </div>
                    <button type="submit" style="width: 100%;">Buscar</button>
                </form>
                <div id="datosPropietario" style="display:none;">
                    <div class="card" style="margin-top:10px;">
                        <h3>Propietario</h3>
                        <p><strong>Nombre:</strong> <span id="nombrePropietario"></span></p>
                        <p><strong>Estado actual:</strong> <span id="estadoActual"></span></p>
                    </div>
                </div>
            </div>

            <!-- Columna derecha: estados -->
            <div>
                <label style="font-weight: bold; margin-bottom: 8px; display: block;">Estados definidos</label>
                <form id="formCambiarEstado" onsubmit="cambiarEstado(event)">
                    <div class="input-group">
                        <select id="estados" name="nuevoEstado"></select>
                    </div>
                    <button type="submit" style="width: 100%;">Cambiar estado</button>
                </form>
                <p id="mensajeEstado" style="margin-top: 18px;"></p>
            </div>
        </div>

        <footer style="margin-top: 18px; color: #888; font-size: 13px; text-align:center;">
            © 2025 – Administración
        </footer>
    </div>

    <script>
        urlIniciarVista   = "/cambiar-estado-propietario/vistaConectada";
        urlCierreVista    = "/cambiar-estado-propietario/vistaCerrada";
        urlRegistroSSE    = "/cambiar-estado-propietario/registrarSSE";

        const formBuscar         = document.getElementById('formBuscar');
        const formCambiarEstado  = document.getElementById('formCambiarEstado');
        const cedulaInput        = document.getElementById('cedula');
        const nombrePropietario  = document.getElementById('nombrePropietario');
        const estadoActual       = document.getElementById('estadoActual');
        const estadosSelect      = document.getElementById('estados');
        const datosPropietario   = document.getElementById('datosPropietario');
        const mensajeEstado      = document.getElementById('mensajeEstado');



        function buscarPropietario(event) {
            event.preventDefault();
            mensajeEstado.textContent = "";
            submit("/cambiar-estado-propietario/buscar",
                   serializarFormulario("formBuscar"));
        }

        function cambiarEstado(event) {
            event.preventDefault();
            mensajeEstado.textContent = "";
            submit("/cambiar-estado-propietario/cambiar",
                   serializarFormulario("formCambiarEstado") +
                   "&cedula=" + encodeURIComponent(cedulaInput.value));
        }


        function mostrar_estados(estados) {
            estadosSelect.innerHTML = "";
            if (!Array.isArray(estados)) return;

            estados.forEach(est => {
                const option = document.createElement("option");
                option.value = est;
                option.textContent = est;
                estadosSelect.appendChild(option);
            });
        }


        function mostrar_propietarioBusqueda(dto) {
            if (!dto) {
                datosPropietario.style.display = "none";
                nombrePropietario.textContent = "";
                estadoActual.textContent = "";
                return;
            }

            nombrePropietario.textContent = dto.nombreCompleto;
            estadoActual.textContent      = dto.estado;
            datosPropietario.style.display = "";


            if (dto.estado) {
                for (let i = 0; i < estadosSelect.options.length; i++) {
                    if (estadosSelect.options[i].value === dto.estado) {
                        estadosSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        }


        function mostrar_mensajeEstado(texto) {
            mensajeEstado.textContent = texto || "";
        }


        function mostrar_cambioEstadoPropietario(dto) {

            mostrar_propietarioBusqueda(dto);

            mensajeEstado.textContent = "El estado fue actualizado desde otra operación.";
        }


        async function excepcionDeAplicacion(mensaje) {
            await mostrarMensaje(mensaje);
        }

        function procesarErrorSubmit(status, text) {
            if (status === 400) {

                window.location.href = "login-admin.html";
            } else {
                console.error("Error en submit:", status, text);
            }
        }


        async function conexionSSECerrada(event) {
            let respuesta = await mostrarConfirmacion(
                "Se ha cerrado la aplicación en esta ventana",
                "Intentar volver a abrirla",
                "Cerrar"
            );
            if (respuesta) {
                location.reload();
            } else {
                document.body.innerHTML = "";
            }
        }
    </script>
</body>
</html>
