<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitor actividad y Emular Tránsito</title>
  <link rel="stylesheet" href="Estilos.css">
  <script src="vistaWeb.js"></script>
  <script src="sse.js"></script>
  <script>
    // Configuración inicial de la vista y SSE
    window.urlIniciarVista = "/admin/vistaConectada"; // POST inicial (registra observador y datos base)
    window.urlCierreVista = "/admin/vistaCerrada";    // POST cierre (quitar observador)
    window.urlRegistroSSE = "/admin/registrarSSE";    // GET SSE (EventSource)

    // Redirección si la sesión expiró
    window.procesarErrorSubmit = function (status, text) {
      if (status === 400 || status === 401) {
        alert("Sesión expirada");
        window.location.href = "login-admin.html";
      }
    };
  </script>
  <script defer src="utilesVista.js"></script>
</head>

<body class="vista-interna">
  <div class="login-container" style="max-width: 900px;">
    <h2 style="text-align:left; margin-bottom: 10px;">Emular tránsito</h2>
    <p style="color: #555; margin-bottom: 18px; text-align:left;">Seleccione un puesto, verifique sus tarifas, ingrese
      una matrícula y emule un tránsito.</p>
    <form id="formEmular" onsubmit="handleEmularTransito(event)">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; align-items: start;">
        <!-- Columna izquierda: Puesto y matrícula -->
        <div>
          <div class="input-group">
            <label for="puesto">Puesto</label>
            <select id="puesto" name="puesto" required onchange="cargarTarifas()">
              <option value="">-- Seleccione un puesto --</option>
            </select>
          </div>
          <div class="input-group">
            <label for="matricula">Matrícula</label>
            <input type="text" id="matricula" name="matricula" placeholder="Ej: ABC1234" required />
          </div>
          <div class="input-group">
            <label for="fecha">Fecha y hora del tránsito</label>
            <input type="datetime-local" id="fechaHora" name="fechaHora" required />
          </div>
          <button type="submit" style="width: 100%;">Emular tránsito</button>
        </div>
        <!-- Columna derecha: Tarifas del puesto -->
        <div>
          <label style="font-weight: bold; margin-bottom: 8px; display: block;">Tarifas del puesto</label>
          <table style="width: 100%; margin-top: 10px;">
            <thead>
              <tr>
                <th>Categoría</th>
                <th>Monto</th>
              </tr>
            </thead>
            <tbody id="tbodyTarifas">
              <tr>
                <td colspan="2" style="text-align: center; color: #999;">Se muestran categoría y monto actuales del
                  puesto seleccionado.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </form>
    <div style="margin-top:25px"><strong>Total tránsitos registrados:</strong> <span id="spanTotalTransitos">0</span>
    </div>
    <div id="resultado" style="margin-top: 30px; display: none; text-align:left;">
      <h4>Resultado</h4>
      <p><strong>Propietario:</strong> <span id="resPropietario"></span></p>
      <p><strong>Categoría:</strong> <span id="resCategoria"></span></p>
      <p><strong>Bonificación:</strong> <span id="resBonificacion"></span></p>
      <p><strong>Costo del tránsito:</strong> <span id="resCosto"></span></p>
      <p><strong>Saldo luego del tránsito:</strong> <span id="resSaldo"></span></p>
    </div>
    <footer style="margin-top: 18px; color: #888; font-size: 13px; text-align:center;">© 2025 – Emular tránsitos
    </footer>
  </div>


  <script>
    let puestosData = [];

    // Función para mostrar información del admin
    function mostrar_infoAdmin(nombreCompleto) {
      document.getElementById('nombreAdmin').textContent = nombreCompleto;
    }

    // Total de tránsitos (SSE)
    function mostrar_totalTransitos(total) {
      const el = document.getElementById('spanTotalTransitos');
      if (el) el.textContent = total;
    }

    // Función para cargar lista de puestos
    function mostrar_puestos(lista) {
      puestosData = lista;
      const select = document.getElementById('puesto');
      select.innerHTML = '<option value="">-- Seleccione un puesto --</option>';

      if (!lista || !lista.length) {
        select.innerHTML += '<option value="" disabled>No hay puestos disponibles</option>';
        return;
      }

      for (const p of lista) {
        const option = document.createElement('option');
        option.value = p.nombre;
        option.textContent = p.nombre;
        select.appendChild(option);
      }
    }

    // Función para cargar tarifas cuando cambia el puesto
    function cargarTarifas() {
      const nombrePuesto = document.getElementById('puesto').value;
      if (!nombrePuesto) {
        document.getElementById('tbodyTarifas').innerHTML =
          '<tr><td colspan="2" style="text-align: center; color: #999;">Se muestran categoría y monto actuales del puesto seleccionado.</td></tr>';
        return;
      }

      submit("/admin/obtenerTarifas", "nombrePuesto=" + encodeURIComponent(nombrePuesto));
    }

    // Función para mostrar tarifas del puesto seleccionado
    function mostrar_tarifas(lista) {
      const tbody = document.getElementById('tbodyTarifas');
      tbody.innerHTML = "";

      if (!lista || !lista.length) {
        tbody.innerHTML = '<tr><td colspan="2" style="text-align: center;">No hay tarifas definidas</td></tr>';
        return;
      }

      for (const t of lista) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t.categoria}</td>
          <td>$ ${parseFloat(t.monto).toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Función para emular tránsito
    function handleEmularTransito(event) {
      event.preventDefault();
      // Limpiar resultado anterior
      document.getElementById('resultado').style.display = 'none';
      const formData = new FormData(event.target);
      const params = new URLSearchParams();
      params.append('nombrePuesto', formData.get('puesto'));
      params.append('matricula', formData.get('matricula'));
      // fechaHora en formato yyyy-MM-ddTHH:mm
      const fechaHora = formData.get('fechaHora');
      if (fechaHora) {
        const [fecha, hora] = fechaHora.split('T');
        params.append('fecha', fecha);
        params.append('hora', hora);
      }
      submit("/admin/emularTransito", params.toString());
    }

    // Función para mostrar resultado de la emulación
    function mostrar_resultadoEmulacion(datos) {
      document.getElementById('resPropietario').textContent = datos.nombrePropietario + ' (' + datos.estado + ')';
      document.getElementById('resCategoria').textContent = datos.categoria;
      document.getElementById('resBonificacion').textContent = datos.bonificacion || 'Sin bonificación';
      document.getElementById('resCosto').textContent = '$ ' + parseFloat(datos.costoTransito).toFixed(2);
      document.getElementById('resSaldo').textContent = '$ ' + parseFloat(datos.saldoDespues).toFixed(2);

      document.getElementById('resultado').style.display = 'block';
    }

    // Logout
    function logout() {
      if (confirm("¿Está seguro que desea salir?")) {
        submit("/acceso/logoutAdmin", "");
      }
    }

    // Redirección post-logout
    function mostrar_paginaLogin(url) {
      window.location.href = url;
    }

    // Inicializar fecha y hora actual
    document.addEventListener("DOMContentLoaded", function () {
      const now = new Date();
      // Formato: yyyy-MM-ddTHH:mm
      const pad = n => n.toString().padStart(2, '0');
      const local = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
      const fechaHoraInput = document.getElementById('fechaHora');
      if (fechaHoraInput) fechaHoraInput.value = local;
    });
  </script>
</body>

</html>